#!/bin/bash

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è logistics.xrom.org"
echo "================================================="

echo "–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ VPS –∫–∞–∫ root:"
echo ""
echo "# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞"
echo "sudo systemctl stop hromkz"
echo ""
echo "# 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞"
echo "sudo chown -R hromkz:www-data /var/www/logistics.xrom.org"
echo "sudo chmod -R 755 /var/www/logistics.xrom.org"
echo "sudo chmod 775 /var/www/logistics.xrom.org"
echo ""
echo "# 3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Å–æ–∫–µ—Ç–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏"
echo "sudo mkdir -p /var/www/logistics.xrom.org/run"
echo "sudo chown hromkz:www-data /var/www/logistics.xrom.org/run"
echo "sudo chmod 775 /var/www/logistics.xrom.org/run"
echo ""
echo "# 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—É—Ç–µ–º –∫ —Å–æ–∫–µ—Ç—É"
echo "sudo tee /etc/systemd/system/hromkz.service << 'EOF'"
echo "[Unit]"
echo "Description=Hrom KZ Full Logistics System"
echo "After=network.target"
echo ""
echo "[Service]"
echo "User=hromkz"
echo "Group=www-data"
echo "WorkingDirectory=/var/www/logistics.xrom.org"
echo "Environment=\"PATH=/var/www/logistics.xrom.org/venv/bin\""
echo "EnvironmentFile=/var/www/logistics.xrom.org/.env"
echo "ExecStart=/var/www/logistics.xrom.org/venv/bin/gunicorn --workers 3 --bind unix:/var/www/logistics.xrom.org/run/hromkz.sock --umask 0007 main:app"
echo "ExecReload=/bin/kill -s HUP \$MAINPID"
echo "Restart=always"
echo "RestartSec=10"
echo ""
echo "[Install]"
echo "WantedBy=multi-user.target"
echo "EOF"
echo ""
echo "# 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
echo "sudo tee /etc/nginx/sites-available/logistics.xrom.org << 'EOF'"
echo "server {"
echo "    listen 80;"
echo "    server_name logistics.xrom.org;"
echo ""
echo "    location = /favicon.ico { "
echo "        access_log off; "
echo "        log_not_found off; "
echo "    }"
echo "    "
echo "    location /static/ {"
echo "        alias /var/www/logistics.xrom.org/static/;"
echo "        expires 1y;"
echo "        add_header Cache-Control \"public, immutable\";"
echo "    }"
echo ""
echo "    location / {"
echo "        include proxy_params;"
echo "        proxy_pass http://unix:/var/www/logistics.xrom.org/run/hromkz.sock;"
echo "        proxy_set_header Host \$host;"
echo "        proxy_set_header X-Real-IP \$remote_addr;"
echo "        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;"
echo "        proxy_set_header X-Forwarded-Proto \$scheme;"
echo "    }"
echo "}"
echo "EOF"
echo ""
echo "# 6. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –∏ –∑–∞–ø—É—Å–∫"
echo "sudo systemctl daemon-reload"
echo "sudo systemctl enable hromkz"
echo "sudo systemctl start hromkz"
echo "sudo nginx -t && sudo systemctl reload nginx"
echo ""
echo "# 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞"
echo "sudo systemctl status hromkz"
echo ""
echo "–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–∏—Ö –∫–æ–º–∞–Ω–¥ —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å!"